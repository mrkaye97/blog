<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>A Gentle Introduction to Markov Chains and MCMC - Musings</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Matt Kaye" /><meta name="description" content="Introduction Every other Friday at work, we have a meeting called All Hands, during the first half of which a member of the team gives a presentation. The presentation is split up into two pieces: A personal presentation &amp;ndash; your favorite food, TV shows, books, etc. &amp;ndash; and a mini-lesson, which can be about any topic of interest that&amp;rsquo;s unrelated to work. Yesterday it was my turn, and I gave my mini-lesson on Markov Chains and Markov Chain Monte Carlo." />






<meta name="generator" content="Hugo 0.80.0 with theme even" />


<link rel="canonical" href="https://mrkaye97.github.io/blog/post/2021-01-13-a-gentle-introduction-to-markov-chains-and-mcmc/" />
<link rel="apple-touch-icon" sizes="180x180" href="/blog/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/blog/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/blog/favicon-16x16.png">
<link rel="manifest" href="/blog/manifest.json">
<link rel="mask-icon" href="/blog/safari-pinned-tab.svg" color="#5bbad5">



<link href="/blog/sass/main.min.931eb87b26ffb882f56d8c3e0e784540443c5e475bf69a5ada9cd38ed7457217.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="A Gentle Introduction to Markov Chains and MCMC" />
<meta property="og:description" content="Introduction Every other Friday at work, we have a meeting called All Hands, during the first half of which a member of the team gives a presentation. The presentation is split up into two pieces: A personal presentation &ndash; your favorite food, TV shows, books, etc. &ndash; and a mini-lesson, which can be about any topic of interest that&rsquo;s unrelated to work. Yesterday it was my turn, and I gave my mini-lesson on Markov Chains and Markov Chain Monte Carlo." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mrkaye97.github.io/blog/post/2021-01-13-a-gentle-introduction-to-markov-chains-and-mcmc/" />
<meta property="article:published_time" content="2021-01-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-01-13T18:53:40-07:00" />
<meta itemprop="name" content="A Gentle Introduction to Markov Chains and MCMC">
<meta itemprop="description" content="Introduction Every other Friday at work, we have a meeting called All Hands, during the first half of which a member of the team gives a presentation. The presentation is split up into two pieces: A personal presentation &ndash; your favorite food, TV shows, books, etc. &ndash; and a mini-lesson, which can be about any topic of interest that&rsquo;s unrelated to work. Yesterday it was my turn, and I gave my mini-lesson on Markov Chains and Markov Chain Monte Carlo.">
<meta itemprop="datePublished" content="2021-01-13T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-01-13T18:53:40-07:00" />
<meta itemprop="wordCount" content="2263">



<meta itemprop="keywords" content="data science,statistics,bayesian,algorithms," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="A Gentle Introduction to Markov Chains and MCMC"/>
<meta name="twitter:description" content="Introduction Every other Friday at work, we have a meeting called All Hands, during the first half of which a member of the team gives a presentation. The presentation is split up into two pieces: A personal presentation &ndash; your favorite food, TV shows, books, etc. &ndash; and a mini-lesson, which can be about any topic of interest that&rsquo;s unrelated to work. Yesterday it was my turn, and I gave my mini-lesson on Markov Chains and Markov Chain Monte Carlo."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/blog/" class="logo">Musings</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="https://mrkaye97.github.io">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/blog/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/blog/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/blog/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/blog/" class="logo">Musings</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="https://mrkaye97.github.io">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/blog/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/blog/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/blog/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">A Gentle Introduction to Markov Chains and MCMC</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-01-13 </span>
        <div class="post-category">
            <a href="/blog/categories/data-science/"> data science </a>
            </div>
          <span class="more-meta"> 2263 words </span>
          <span class="more-meta"> 11 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#markov-chains">Markov Chains</a></li>
    <li><a href="#markov-chain-monte-carlo">Markov Chain Monte Carlo</a></li>
    <li><a href="#recap">Recap</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h1 id="introduction">Introduction</h1>
<p>Every other Friday at work, we have a meeting called All Hands, during the first half of which a member of the team gives a presentation. The presentation is split up into two pieces: A personal presentation &ndash; your favorite food, TV shows, books, etc. &ndash; and a mini-lesson, which can be about any topic of interest that&rsquo;s unrelated to work. Yesterday it was my turn, and I gave my mini-lesson on Markov Chains and Markov Chain Monte Carlo. This post memorializes what I covered.</p>
<h1 id="markov-chains">Markov Chains</h1>
<p>First, what is a Markov Chain? It&rsquo;s easiest to break it down into it&rsquo;s component parts. A <strong>Markov Chain</strong> is a <em>chain</em>, or sequence of events, that follow the Markov Property. So, then, what&rsquo;s the Markov Property? It&rsquo;s actually quite intutive: The <strong>Markov Property</strong> says that the next state in a sequence (chain) is only dependent on the current state. Statisticians would call this &ldquo;memorylessness,&rdquo; and we can write out the property in its true mathematical form below, where $ X $ is a random variable and $ x_{t} $ is the probability distribution that $ X $ takes on at time $ t $.</p>
<p>$$
p(x_{t+1} | x_{t}, x_{t-1}, x_{t-2}, .. x_{0}) = p(x_{t+1} | x_{t})
$$</p>
<p>In plain English, all this definition is saying is that if you are following the Markov Property, then where you go next is only determined by where you are now, and how you got to where you are has no impact. At the end of my talk, one of my coworkers commented that this property is actually quite beautiful in a real-world sense, and I feel the same way. It certainly could have been the example of a guiding principle that I choose to follow that I used in my personal presentation.</p>
<p>So, now that we know what a Markov Chain is, let&rsquo;s walk through an example. The most commonly seen type of Markov Chain is called a <em>random walk</em>. Simply, a <strong>random walk</strong> is a Markov Chain where the next state is just determined by the current state plus some random noise. I&rsquo;ve coded up an example below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="c1">## library(purrr)</span>
<span class="c1">## library(magrittr)</span>
<span class="c1">## library(ggplot2)</span>

<span class="n">randomly_walk</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">.ix</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(),</span> <span class="n">n_steps</span> <span class="o">=</span> <span class="m">100</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">results</span> <span class="o">&lt;-</span> <span class="nf">numeric</span><span class="p">(</span><span class="n">n_steps</span><span class="p">)</span>
  <span class="nf">for </span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="n">n_steps</span><span class="m">-1</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">results[i</span> <span class="o">+</span> <span class="m">1</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="n">results[i]</span> <span class="o">+</span> <span class="nf">rnorm</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
  <span class="p">}</span>
  
  <span class="nf">return</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="p">}</span>

<span class="p">(</span>
  <span class="n">random_walk</span> <span class="o">&lt;-</span> <span class="nf">randomly_walk</span><span class="p">()</span> <span class="o">%&gt;%</span>
    <span class="nf">tibble</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">.)</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">## # A tibble: 100 x 1
##    position
##       &lt;dbl&gt;
##  1    0    
##  2    0.812
##  3    1.17 
##  4    0.981
##  5    1.70 
##  6    2.36 
##  7    3.00 
##  8    2.32 
##  9    3.13 
## 10    4.23 
## # … with 90 more rows
</code></pre></td></tr></table>
</div>
</div><p>That table shows a random walk with 100 steps, generated by adding standard normal noise to the position after each step. Let&rsquo;s plot it and see what it looks like.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="n">random_walk</span> <span class="o">%&gt;%</span>
  <span class="nf">rownames_to_column</span><span class="p">(</span><span class="n">var</span> <span class="o">=</span> <span class="s">&#39;time&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span> <span class="o">%&gt;%</span> <span class="nf">as.numeric</span><span class="p">())</span> <span class="o">%&gt;%</span>
  <span class="nf">ggplot</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">position</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">geom_line</span><span class="p">()</span> <span class="o">+</span>
  <span class="nf">theme_minimal</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="static/rmarkdown-libsunnamed-chunk-3-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Cool! The walk starts at $ 0 $, and then jumps around randomly a bunch until $ t=100 $. It&rsquo;ll be more interesting once we simulate 20 random walks.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="n">n_steps</span> <span class="o">&lt;-</span> <span class="m">500</span>
<span class="n">n_chains</span> <span class="o">&lt;-</span> <span class="m">20</span>
<span class="n">twenty_walks</span> <span class="o">&lt;-</span> <span class="nf">map</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">n_chains</span><span class="p">,</span> <span class="n">randomly_walk</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">tibble</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">.)</span> <span class="o">%&gt;%</span>
  <span class="nf">unnest</span><span class="p">(</span><span class="n">cols</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="n">position</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">n_chains</span><span class="p">),</span>
         <span class="n">walk</span> <span class="o">=</span> <span class="nf">map</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">n_chains</span><span class="p">,</span> <span class="n">rep</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">unlist</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">as.factor</span><span class="p">())</span>

<span class="n">twenty_walks</span> <span class="o">%&gt;%</span>
  <span class="nf">ggplot</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">walk</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">geom_line</span><span class="p">()</span> <span class="o">+</span>
  <span class="nf">theme_minimal</span><span class="p">()</span> <span class="o">+</span> 
  <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s">&#39;none&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="static/rmarkdown-libsunnamed-chunk-4-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>So, what&rsquo;s going on here? It basically looks how we&rsquo;d expect. At any given time point, the mean position of the $ 20 $ is about zero, but the standard deviation of those positions goes up over time. Specifically, at any given time $ t $, the standard deviation of the positions should be roughly equal to $ \sqrt t $, because of how the variance is compounding. Remember, these random walks are Markov Chains because at every time $ t $, I defined the position $ y_{t+1} $ to be $ y_{t} + \mathcal{N}(0, 1) $, or the the next position is the current position plus a standard normal noise (i.e. zero-centered with unit variance).</p>
<p>Cool, so now we have an idea of what a Markov Chain is and how a random walk is an example of one. Now, why do we care? What kinds of problems can we solve with Markov Chains? It turns out that one thing we can use them to do is to calculate intractable integrals. What does this mean? Well, remembering back to a calculus class once upon a time, we know if we have some function $ f(x) = 2x $, we can integrate that function by following a one of a couple of rules. In this case, that rule is to raise the coefficient in front of the $ x $ to turn it into a power, such that the new exponent equals the old one plus one, and the new coefficient equals the old one divided by the new exponent. For $ f(x) $, we find $ F(x) = \int f(x) = x^{2} + c $, where $ c $ is a constant. However, in many applications, such as Bayesian statistics, we run into functions of hundreds or thousands of parameters that are intractable to integrate. In other words, even really, really powerful calculators can&rsquo;t integrate them: there are just too many parameters. So, we&rsquo;re stuck. How do we integrate a function that even a super powerful calculator can&rsquo;t? In steps Markov Chain Monte Carlo, coming to the rescue.</p>
<h1 id="markov-chain-monte-carlo">Markov Chain Monte Carlo</h1>
<p>It turns out that we can use Markov Chains to approximate the integral in cases where we can&rsquo;t calculate it directly. This is an incredible powerful discovery, and one that we&rsquo;ve only been able to really take advantage of in the past twenty or so years, as computing power has grown exponentially. So, how do we actually do it? Let&rsquo;s frame it as a simple problem that&rsquo;s isomorphic to the actual problem at hand.</p>
<p>Imagine you are the ruler of an island kingdom, which has four islands. Island 1 has population 1, Island 2 has population 2, Island 3 has population 3, and Island 4 has population 4. And, imagine that you want to spend time on each island proportional to the percentage of the total population of your kingdom that it makes up. In other words, you want to spend 10% of your time on Island 1, and so on. But, you have a problem: You don&rsquo;t know how to add. Imagine that the only mathematical operation you know how to do is divide. Can you figure out a way to spend your time how you want without being able to calculate the total population of your kingdom?</p>
<p>Most likely, how you&rsquo;d solve this problem isn&rsquo;t immediately obvious, but there are a few brilliant algorithms that help us achieve our goal. One of them is proposed to you by two of your friends, Metropolis and Hastings. I&rsquo;ve coded up their suggestion below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="n">run_rwmh</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">n_iters</span> <span class="o">=</span> <span class="m">1000</span><span class="p">,</span> <span class="n">island_populations</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="m">4</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">locations</span> <span class="o">&lt;-</span> <span class="nf">numeric</span><span class="p">(</span><span class="n">n_iters</span><span class="p">)</span>
  
  <span class="c1">## randomly choose an island to start on</span>
  <span class="n">locations[1]</span> <span class="o">&lt;-</span> <span class="nf">sample</span><span class="p">(</span><span class="n">island_populations</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>

  <span class="nf">for </span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="n">n_iters</span><span class="m">-1</span><span class="p">))</span> <span class="p">{</span>
    
    <span class="c1">## propose a new island to go to</span>
    <span class="n">proposal_island</span> <span class="o">&lt;-</span> <span class="nf">sample</span><span class="p">(</span><span class="nf">setdiff</span><span class="p">(</span><span class="n">island_populations</span><span class="p">,</span> <span class="n">locations[i]</span><span class="p">),</span> <span class="m">1</span><span class="p">)</span> 
    
    <span class="c1">## if that island has more people, always go</span>
    <span class="nf">if </span><span class="p">(</span><span class="n">proposal_island</span> <span class="o">&gt;</span> <span class="n">locations[i]</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">locations[i</span> <span class="o">+</span> <span class="m">1</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="n">proposal_island</span>
    <span class="p">}</span> <span class="n">else</span> <span class="p">{</span>
      <span class="c1">## if it has fewer people, flip a coin with probability</span>
      <span class="c1">##   proportional to the ratio of the populations to</span>
      <span class="c1">##   decide whether to go or stay</span>
      <span class="n">acceptance_probability</span> <span class="o">&lt;-</span> <span class="n">proposal_island</span> <span class="o">/</span> <span class="n">locations[i]</span>
      <span class="n">locations[i</span> <span class="o">+</span> <span class="m">1</span><span class="n">]</span> <span class="o">&lt;-</span> 
        <span class="nf">sample</span><span class="p">(</span>
          <span class="nf">c</span><span class="p">(</span><span class="n">proposal_island</span><span class="p">,</span> <span class="n">locations[i]</span><span class="p">),</span> <span class="m">1</span><span class="p">,</span> 
          <span class="n">prob</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="n">acceptance_probability</span><span class="p">,</span> <span class="m">1</span> <span class="o">-</span> <span class="n">acceptance_probability</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nf">return</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Here&rsquo;s the algorithm your friends propose:</p>
<ol>
<li>Pick a random island to start on.</li>
<li>On each day, randomly select a new island to go to (the <strong>proposal island</strong>).</li>
<li>Do one of the following, depending on the populations of the islands:
i. If the proposal island has more people than the current island, go to the proposal island.
ii. If it has fewer people, then flip a coin with probability equal to the proposal island&rsquo;s population divided by the current island&rsquo;s. If the coin comes up heads, go to the proposal island.</li>
<li>Do it again a bunch of times.</li>
</ol>
<p>So, how does this algorithm perform? Let&rsquo;s try it out!</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">run_rwmh</span><span class="p">(</span><span class="n">n_iters</span> <span class="o">=</span> <span class="m">10</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">tibble</span><span class="p">(</span><span class="n">island</span> <span class="o">=</span> <span class="n">.)</span> <span class="o">%&gt;%</span>
  <span class="nf">group_by</span><span class="p">(</span><span class="n">island</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">summarize</span><span class="p">(</span><span class="n">days_spent</span> <span class="o">=</span> <span class="nf">n</span><span class="p">(),</span> <span class="n">.groups</span> <span class="o">=</span> <span class="s">&#39;drop&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">day_proportion</span> <span class="o">=</span> <span class="n">days_spent</span> <span class="o">/</span> <span class="nf">sum</span><span class="p">(</span><span class="n">days_spent</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">## # A tibble: 4 x 3
##   island days_spent day_proportion
##    &lt;dbl&gt;      &lt;int&gt;          &lt;dbl&gt;
## 1      1          2            0.2
## 2      2          3            0.3
## 3      3          3            0.3
## 4      4          2            0.2
</code></pre></td></tr></table>
</div>
</div><p>Unsurprisingly, with only $ 10 $ iterations the algorithm does not perform particularly well. But what about if we give it a lot more time? Let&rsquo;s try $ 10,000 $ iterations.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="n">some_islands</span> <span class="o">&lt;-</span> <span class="nf">run_rwmh</span><span class="p">(</span><span class="n">n_iters</span> <span class="o">=</span> <span class="m">10000</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">tibble</span><span class="p">(</span><span class="n">island</span> <span class="o">=</span> <span class="n">.)</span> <span class="o">%&gt;%</span>
  <span class="nf">group_by</span><span class="p">(</span><span class="n">island</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">summarize</span><span class="p">(</span><span class="n">days_spent</span> <span class="o">=</span> <span class="nf">n</span><span class="p">(),</span> <span class="n">.groups</span> <span class="o">=</span> <span class="s">&#39;drop&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">day_proportion</span> <span class="o">=</span> <span class="n">days_spent</span> <span class="o">/</span> <span class="nf">sum</span><span class="p">(</span><span class="n">days_spent</span><span class="p">),</span>
         <span class="n">error_margin</span> <span class="o">=</span> <span class="n">day_proportion</span> <span class="o">/</span> <span class="p">(</span><span class="n">island</span> <span class="o">/</span> <span class="nf">sum</span><span class="p">(</span><span class="n">island</span><span class="p">))</span> <span class="o">-</span> <span class="m">1</span><span class="p">)</span>

<span class="n">mean_error_margin</span> <span class="o">&lt;-</span> <span class="nf">mean</span><span class="p">(</span><span class="n">some_islands</span><span class="o">$</span><span class="n">error_margin</span><span class="p">)</span>
<span class="n">sd_error_margin</span> <span class="o">&lt;-</span> <span class="nf">sd</span><span class="p">(</span><span class="n">some_islands</span><span class="o">$</span><span class="n">error_margin</span><span class="p">)</span>
<span class="n">some_islands</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">## # A tibble: 4 x 4
##   island days_spent day_proportion error_margin
##    &lt;dbl&gt;      &lt;int&gt;          &lt;dbl&gt;        &lt;dbl&gt;
## 1      1        982         0.0982      -0.018 
## 2      2       2000         0.2          0     
## 3      3       3065         0.306        0.0217
## 4      4       3953         0.395       -0.0118
</code></pre></td></tr></table>
</div>
</div><p>Much better! After $ 10,000 $ iterations, we&rsquo;re spending almost the exact proportion of time on each island that we want to be, as evidenced by the tiny error margins. In addition, the standard deviation of the error margins is 0.01747, which is tiny. That&rsquo;s awesome! But what about if the system is more complex? Like, what if we had 100 islands?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="n">more_islands</span> <span class="o">&lt;-</span> <span class="nf">run_rwmh</span><span class="p">(</span><span class="n">n_iters</span> <span class="o">=</span> <span class="m">10000</span><span class="p">,</span> <span class="n">island_populations</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="m">100</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">tibble</span><span class="p">(</span><span class="n">island</span> <span class="o">=</span> <span class="n">.)</span> <span class="o">%&gt;%</span>
  <span class="nf">group_by</span><span class="p">(</span><span class="n">island</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">summarize</span><span class="p">(</span><span class="n">days_spent</span> <span class="o">=</span> <span class="nf">n</span><span class="p">(),</span> <span class="n">.groups</span> <span class="o">=</span> <span class="s">&#39;drop&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">day_proportion</span> <span class="o">=</span> <span class="n">days_spent</span> <span class="o">/</span> <span class="nf">sum</span><span class="p">(</span><span class="n">days_spent</span><span class="p">),</span>
         <span class="n">error_margin</span> <span class="o">=</span> <span class="n">day_proportion</span> <span class="o">/</span> <span class="p">(</span><span class="n">island</span> <span class="o">/</span> <span class="nf">sum</span><span class="p">(</span><span class="n">island</span><span class="p">))</span> <span class="o">-</span> <span class="m">1</span><span class="p">)</span>

<span class="n">mean_error_margin</span> <span class="o">&lt;-</span> <span class="nf">mean</span><span class="p">(</span><span class="n">more_islands</span><span class="o">$</span><span class="n">error_margin</span><span class="p">)</span>
<span class="n">sd_error_margin</span> <span class="o">&lt;-</span> <span class="nf">sd</span><span class="p">(</span><span class="n">more_islands</span><span class="o">$</span><span class="n">error_margin</span><span class="p">)</span>
<span class="n">more_islands</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">## # A tibble: 100 x 4
##    island days_spent day_proportion error_margin
##     &lt;dbl&gt;      &lt;int&gt;          &lt;dbl&gt;        &lt;dbl&gt;
##  1      1          3       0.000300       0.515 
##  2      2          7       0.0007         0.767 
##  3      3          4       0.0004        -0.327 
##  4      4          7       0.0007        -0.116 
##  5      5         12       0.00120        0.212 
##  6      6         11       0.0011        -0.0742
##  7      7         14       0.0014         0.01  
##  8      8         10       0.001         -0.369 
##  9      9         24       0.00240        0.347 
## 10     10         25       0.0025         0.262 
## # … with 90 more rows
</code></pre></td></tr></table>
</div>
</div><p>No problem! Even with the extra islands, the mean error margin is still zero, and the standard deviation of the error margins is 0.18211, which is also small, but not as small as the simpler system. It&rsquo;s true that a more complex system (i.e. more islands) would mean that we need more iterations to converge in probability to the proportions we&rsquo;re shooting for, but the algorithm will still work with enough time. Let&rsquo;s try running it one more time on the complex system, but this time with a million iterations.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="n">more_iters</span> <span class="o">&lt;-</span> <span class="nf">run_rwmh</span><span class="p">(</span><span class="n">n_iters</span> <span class="o">=</span> <span class="m">1000000</span><span class="p">,</span> <span class="n">island_populations</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="m">100</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">tibble</span><span class="p">(</span><span class="n">island</span> <span class="o">=</span> <span class="n">.)</span> <span class="o">%&gt;%</span>
  <span class="nf">group_by</span><span class="p">(</span><span class="n">island</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">summarize</span><span class="p">(</span><span class="n">days_spent</span> <span class="o">=</span> <span class="nf">n</span><span class="p">(),</span> <span class="n">.groups</span> <span class="o">=</span> <span class="s">&#39;drop&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">day_proportion</span> <span class="o">=</span> <span class="n">days_spent</span> <span class="o">/</span> <span class="nf">sum</span><span class="p">(</span><span class="n">days_spent</span><span class="p">),</span>
         <span class="n">error_margin</span> <span class="o">=</span> <span class="n">day_proportion</span> <span class="o">/</span> <span class="p">(</span><span class="n">island</span> <span class="o">/</span> <span class="nf">sum</span><span class="p">(</span><span class="n">island</span><span class="p">))</span> <span class="o">-</span> <span class="m">1</span><span class="p">)</span>

<span class="n">mean_error_margin</span> <span class="o">&lt;-</span> <span class="nf">mean</span><span class="p">(</span><span class="n">more_iters</span><span class="o">$</span><span class="n">error_margin</span><span class="p">)</span>
<span class="n">sd_error_margin</span> <span class="o">&lt;-</span> <span class="nf">sd</span><span class="p">(</span><span class="n">more_iters</span><span class="o">$</span><span class="n">error_margin</span><span class="p">)</span>
<span class="n">more_iters</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">## # A tibble: 100 x 4
##    island days_spent day_proportion error_margin
##     &lt;dbl&gt;      &lt;int&gt;          &lt;dbl&gt;        &lt;dbl&gt;
##  1      1        207       0.000207      0.0453 
##  2      2        411       0.000411      0.0378 
##  3      3        609       0.000609      0.0252 
##  4      4        809       0.000809      0.0214 
##  5      5       1017       0.00102       0.0272 
##  6      6       1194       0.00119       0.00495
##  7      7       1427       0.00143       0.0295 
##  8      8       1616       0.00162       0.0201 
##  9      9       1769       0.00177      -0.00739
## 10     10       1986       0.00199       0.00293
## # … with 90 more rows
</code></pre></td></tr></table>
</div>
</div><p>Looks like that did the trick! The standard deviation of the error margins fell to 0.01485, just as we expected.</p>
<p>This algorithm is called the Metropolis-Hastings Algorithm, and it&rsquo;s one of many in the class of Markov Chain Monte Carlo algorithms. Some others are the Gibbs Sampler and Hamiltonian Monte Carlo, both of which are frequently used in Bayesian statistics for estimating the parameters of regression models with hundreds of thousands of parameters. In short, these algorithms allow us to solve problems that were literally impossible to solve only two decades ago or so, which is an amazing feat!</p>
<h1 id="recap">Recap</h1>
<ul>
<li>Markov Chains are not that scary! They&rsquo;re just a memoryless sequence of events, meaning that where you came from doesn&rsquo;t impact where you go next.</li>
<li>Markov Chain Monte Carlo algorithms like the Metropolis-Hastings can be quite simple, and let us solve impossibly hard problems.</li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/blog/tags/data-science/">data science</a>
          <a href="/blog/tags/statistics/">statistics</a>
          <a href="/blog/tags/bayesian/">bayesian</a>
          <a href="/blog/tags/algorithms/">algorithms</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/blog/post/2021-01-10-what-i-ve-been-drinking-in-quarantine/">
            <span class="next-text nav-default">What I&#39;ve Been Drinking in Quarantine (Plus a Cocktail Lesson)</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://github.com/mrkaye97" class="iconfont icon-github" title="github"></a>
      <a href="https://www.linkedin.com/in/kayem20/" class="iconfont icon-linkedin" title="linkedin"></a>
  <a href="https://mrkaye97.github.io/blog/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Matt Kaye</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/blog/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-69391421-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
